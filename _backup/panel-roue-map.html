<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
<head>
    <title>La roue !</title>
    <meta charset='utf-8' />
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible' />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="css/style.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Carter+One' rel='stylesheet' type='text/css' />
    <!--[if IE]><script type="text/javascript" src="js/excanvas.js"></script><![endif]-->
</head>
<body>
    <div id="roue">
        <canvas id="canvas" width="500" height="500"></canvas>
    </div>
    <div id="affichage">
        <div id="panel">
            <input type="button" value="Go!" onclick="spin();" />
            <input type="button" value="Back" onclick="back();">
        </div>

        <div id="bloc-map">
          <div id='map'></div>
            <script type="text/javascript">
                $(document).ready(function()
                    {
                    // Déclaration des variables de recherche
                    var query = "japonnais";
                    var rayon = 400;
                    var key = "AIzaSyDaLlMK7kcVE9WMXD8cNJLlV2T8hIJceRA";
                    var position_lat;
                    var position_long;
                    var jsonObj = [];
                    /**
                    * On formatte l'objet JSON en un GeoJSON
                    * pour placer les points sur MapBox
                    */ 
                    function tr(json)
                    {
                        for (var i = 0; i < json.results.length; i++)
                        {
                            jsonObj.push({
                                type:'Feature',
                                geometry:
                                {
                                    type:'Point',
                                    coordinates: [json.results[i].geometry.location.lng,
                                    json.results[i].geometry.location.lat]
                                },
                                properties:
                                {
                                    title: json.results[i].name,
                                    description: 'Description',
                                    'marker-size': 'medium',
                                    'marker-color':'#046380',
                                    'marker-symbol': 'restaurant'
                                }
                            });
                        }
                        return jsonObj;
                    }

                    /**
                    *
                    * Fonction callback d'erreur
                    */ 
                    function erreurPosition(error) {
                        var info = "Erreur lors de la géolocalisation : ";
                        switch(error.code) {
                            case error.TIMEOUT:
                            info += "Timeout !";
                            break;
                            case error.PERMISSION_DENIED:
                            info += "Vous n’avez pas donné la permission";
                            break;
                            case error.POSITION_UNAVAILABLE:
                            info += "La position n’a pu être déterminée";
                            break;
                            case error.UNKNOWN_ERROR:
                            info += "Erreur inconnue";
                            break;
                        }
                    }

                    /**
                    * Lance la fonction de géolicalisation 
                    * Affichage de la carte
                    */ 
                    function afficher_points_carte()
                    {
                        navigator.geolocation.getCurrentPosition(affichePosition,erreurPosition);
                    }

                    /**
                    * Fait le test si le navigateur supporte la géolocalisation
                    */ 
                    if(navigator.geolocation) 
                    {
                        console.log("position 1 :"+position_lat);

                        // Fonction de callback en cas de succès
                        function affichePosition(position) 
                        {
                          //Déclaration de l'objet Map
                          var map = L.mapbox.map('map', 'examples.map-9ijuk24y').setView([position.coords.latitude ,position.coords.longitude], 11);

                          // Ajout des points issus de GOOGLE PLACES sur la carte
                          L.mapbox.markerLayer(jsonObj).addTo(map);
                        }
                    }

                    /**
                    * On récupère les données JSON depuis l'API Google Places
                    * Utilisation d'un Apel AJAX avec JQuery
                    * On envoi le résultat a la fonction tr pour modification
                    */ 
                    $.ajax({ 
                        url : "https://maps.googleapis.com/maps/api/place/textsearch/json?query="+query+"&location=48.853526,2.379934&radius="+rayon+"&types=food|restaurant&sensor=false&key="+key,
                        dataType : "json", 
                        success : function(json)
                        {
                            // Passage a la fonction tr() pour transformation
                            jsonObj=tr(json);
                            //Affichage des points sur la carte
                            afficher_points_carte();
                        }
                    });  
                  });
            </script>

            <!--//https://api.foursquare.com/v2/venues/search?client_id=R21TO35023CYTYLFMTCZUBDPGQMZVJKFXOYYFB5NJ1GNKSJZ&client_secret=OFXSG15TZOGK5IHHNV1K55HG03UOKLSHLX0I3WFI2RGJBLMB&v=20130815&ll=48.751989673430685,2.453483282054402&categoryID=4bf58dd8d48988d1e9941735-->
        </div>
    </div>
</div>

<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.js'></script>
<script src='js/roueTourne.js'></script>
</body>
</html>
